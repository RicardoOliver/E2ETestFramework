parameters:
  - name: teamsWebhook
    type: string
  - name: smtpHost
    type: string
  - name: smtpPort
    type: string
  - name: smtpUser
    type: string
  - name: smtpPassword
    type: string
  - name: smtpTo
    type: string

steps:
  - task: PowerShell@2
    displayName: 'Aggregate test results from TRX'
    inputs:
      targetType: inline
      script: |
        $trxFiles = Get-ChildItem -Path '$(Pipeline.Workspace)/all-artifacts' -Filter *.trx -Recurse -ErrorAction SilentlyContinue
        $total = 0; $passed = 0; $failed = 0
        foreach ($trx in $trxFiles) {
          [xml]$xml = Get-Content $trx.FullName
          $counters = $xml.TestRun.ResultSummary.Counters
          if ($counters) {
            $total += [int]$counters.total
            $passed += [int]$counters.passed
            $failed += [int]$counters.failed
          }
        }
        if ($total -gt 0) { $success = [math]::Round(($passed / $total) * 100, 2) } else { $success = 0 }
        Write-Host "##vso[task.setvariable variable=TotalTests]$total"
        Write-Host "##vso[task.setvariable variable=PassedTests]$passed"
        Write-Host "##vso[task.setvariable variable=FailedTests]$failed"
        Write-Host "##vso[task.setvariable variable=SuccessRate]$success"

  - task: PowerShell@2
    displayName: 'Send Adaptive Card to Teams'
    inputs:
      targetType: inline
      script: |
        $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
        $status = "$(Agent.JobStatus)"
        $branch = "$(Build.SourceBranchName)"
        $author = "$(Build.RequestedFor)"
        $duration = "$(Build.BuildNumber)"
        $environment = if ("$(Build.SourceBranch)" -eq 'refs/heads/main') { 'prod' } elseif ("$(Build.SourceBranch)" -eq 'refs/heads/develop') { 'qa' } else { 'dev' }
        $adaptiveCard = @{
          type = 'message'
          attachments = @(@{
            contentType = 'application/vnd.microsoft.card.adaptive'
            content = @{
              '$schema' = 'http://adaptivecards.io/schemas/adaptive-card.json'
              type = 'AdaptiveCard'
              version = '1.4'
              body = @(
                @{ type = 'TextBlock'; size='Large'; weight='Bolder'; text = "Pipeline $status" },
                @{ type = 'FactSet'; facts = @(
                  @{ title='Status'; value=$status },
                  @{ title='Autor'; value=$author },
                  @{ title='Branch'; value=$branch },
                  @{ title='Build'; value='$(Build.BuildId)' },
                  @{ title='Ambiente'; value=$environment },
                  @{ title='Total'; value='$(TotalTests)' },
                  @{ title='Aprovados'; value='$(PassedTests)' },
                  @{ title='Falhos'; value='$(FailedTests)' },
                  @{ title='Taxa sucesso'; value='$(SuccessRate)%' },
                  @{ title='Execução'; value=$duration }
                )}
              )
              actions = @(
                @{ type='Action.OpenUrl'; title='Abrir evidências'; url=$buildUrl }
              )
            }
          })
        }
        $body = $adaptiveCard | ConvertTo-Json -Depth 20
        Invoke-RestMethod -Method Post -ContentType 'application/json' -Uri '${{ parameters.teamsWebhook }}' -Body $body

  - task: PowerShell@2
    displayName: 'Send SMTP email summary'
    inputs:
      targetType: inline
      script: |
        $subject = "[E2E Pipeline] Build $(Build.BuildId) - $(Agent.JobStatus)"
        $environment = if ("$(Build.SourceBranch)" -eq 'refs/heads/main') { 'prod' } elseif ("$(Build.SourceBranch)" -eq 'refs/heads/develop') { 'qa' } else { 'dev' }
        $body = @"
        Status: $(Agent.JobStatus)
        Testes totais: $(TotalTests) | Aprovados: $(PassedTests) | Falhos: $(FailedTests) | Taxa de sucesso: $(SuccessRate)%
        Evidências: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)
        Autor: $(Build.RequestedFor)
        Ambiente impactado: $environment
        "@
        Send-MailMessage -SmtpServer '${{ parameters.smtpHost }}' -Port ${{ parameters.smtpPort }} -UseSsl -Credential (New-Object PSCredential('${{ parameters.smtpUser }}',(ConvertTo-SecureString '${{ parameters.smtpPassword }}' -AsPlainText -Force))) -From '${{ parameters.smtpUser }}' -To '${{ parameters.smtpTo }}' -Subject $subject -Body $body
