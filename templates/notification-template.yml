parameters:
  - name: teamsWebhook
    type: string
  - name: smtpHost
    type: string
  - name: smtpPort
    type: string
  - name: smtpUser
    type: string
  - name: smtpPassword
    type: string
  - name: smtpTo
    type: string

steps:
  - task: PowerShell@2
    displayName: 'Send Adaptive Card to Teams'
    inputs:
      targetType: inline
      script: |
        $buildUrl = "$(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
        $status = "$(Agent.JobStatus)"
        $branch = "$(Build.SourceBranchName)"
        $author = "$(Build.RequestedFor)"
        $duration = "$(Build.BuildNumber)"
        $adaptiveCard = @{
          type = 'message'
          attachments = @(@{
            contentType = 'application/vnd.microsoft.card.adaptive'
            content = @{
              '$schema' = 'http://adaptivecards.io/schemas/adaptive-card.json'
              type = 'AdaptiveCard'
              version = '1.4'
              body = @(
                @{ type = 'TextBlock'; size='Large'; weight='Bolder'; text = "Pipeline $status" },
                @{ type = 'FactSet'; facts = @(
                  @{ title='Status'; value=$status },
                  @{ title='Autor'; value=$author },
                  @{ title='Branch'; value=$branch },
                  @{ title='Build'; value='$(Build.BuildId)' },
                  @{ title='Ambiente'; value='prod' },
                  @{ title='Execução'; value=$duration }
                )}
              )
              actions = @(
                @{ type='Action.OpenUrl'; title='Abrir evidências'; url=$buildUrl }
              )
            }
          })
        }
        $body = $adaptiveCard | ConvertTo-Json -Depth 20
        Invoke-RestMethod -Method Post -ContentType 'application/json' -Uri '${{ parameters.teamsWebhook }}' -Body $body

  - task: PowerShell@2
    displayName: 'Send SMTP email summary'
    inputs:
      targetType: inline
      script: |
        $subject = "[E2E Pipeline] Build $(Build.BuildId) - $(Agent.JobStatus)"
        $body = @"
        Status: $(Agent.JobStatus)
        Testes aprovados/falhos: consultar TestResults no build.
        Evidências: $(System.TeamFoundationCollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)
        Autor: $(Build.RequestedFor)
        Ambiente impactado: prod
        "@
        Send-MailMessage -SmtpServer '${{ parameters.smtpHost }}' -Port ${{ parameters.smtpPort }} -UseSsl -Credential (New-Object PSCredential('${{ parameters.smtpUser }}',(ConvertTo-SecureString '${{ parameters.smtpPassword }}' -AsPlainText -Force))) -From '${{ parameters.smtpUser }}' -To '${{ parameters.smtpTo }}' -Subject $subject -Body $body
