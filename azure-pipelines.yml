trigger:
  branches:
    include:
      - main
      - develop
      - feature/*

pr:
  branches:
    include:
      - main
      - develop

name: '$(Date:yyyyMMdd).$(Rev:r)'

variables:
  - name: BuildConfiguration
    value: Release
  - name: DotNetSdkVersion
    value: 8.0.x
  - name: CoverageThreshold
    value: '80'
  - name: ArtifactRoot
    value: '$(Build.ArtifactStagingDirectory)/evidence'
  - name: TestProject
    value: 'E2ETestFramework.Tests/E2ETestFramework.Tests.csproj'
  - name: DockerRepository
    value: 'e2e-test-framework'
  - name: ContainerRegistryServiceConnection
    value: 'sc-acr-enterprise'
  - name: SonarServiceConnection
    value: 'sc-sonarqube-enterprise'
  - name: KeyVaultName
    value: 'kv-e2e-enterprise'

stages:
- stage: Validation
  displayName: '1) Validation'
  jobs:
    - job: ValidateBranchAndVersion
      displayName: 'Validate branch policy and semantic version'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
          fetchDepth: 0

        - task: PowerShell@2
          displayName: 'Validate source branch strategy'
          inputs:
            targetType: inline
            script: |
              $branch = "$(Build.SourceBranch)"
              $allowed = @('refs/heads/main','refs/heads/develop')
              $isFeature = $branch -like 'refs/heads/feature/*'
              if (($allowed -notcontains $branch) -and -not $isFeature) {
                Write-Error "Branch '$branch' is not allowed. Use feature/*, develop or main."
                exit 1
              }
              Write-Host "Branch validation passed for $branch"

        - task: PowerShell@2
          displayName: 'Validate project versioning'
          inputs:
            targetType: inline
            script: |
              [xml]$project = Get-Content "E2ETestFramework/E2ETestFramework.csproj"
              [xml]$sharedProps = Get-Content "Directory.Build.props"
              $version = $project.Project.PropertyGroup.Version
              if ([string]::IsNullOrWhiteSpace($version)) {
                $version = $sharedProps.Project.PropertyGroup.Version
              }
              if ([string]::IsNullOrWhiteSpace($version)) {
                Write-Error "Version element not found in project or Directory.Build.props"
                exit 1
              }
              if ($version -notmatch '^\d+\.\d+\.\d+(-[A-Za-z0-9.-]+)?$') {
                Write-Error "Version '$version' is not semantic version compatible"
                exit 1
              }
              Write-Host "Semantic version validation passed: $version"

- stage: Build
  displayName: '2) Build'
  dependsOn: Validation
  jobs:
    - job: RestoreBuildPublish
      displayName: 'Restore, build, cache and publish artifacts'
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self

        - task: UseDotNet@2
          inputs:
            packageType: sdk
            version: $(DotNetSdkVersion)

        - task: Cache@2
          displayName: 'Cache NuGet packages'
          inputs:
            key: 'nuget | "$(Agent.OS)" | **/*.csproj,nuget.config,global.json'
            restoreKeys: |
              nuget | "$(Agent.OS)"
            path: ~/.nuget/packages

        - task: DotNetCoreCLI@2
          displayName: 'dotnet restore'
          inputs:
            command: restore
            projects: '**/*.csproj'

        - task: DotNetCoreCLI@2
          displayName: 'dotnet build'
          inputs:
            command: build
            projects: 'E2ETestFramework.sln'
            arguments: '--configuration $(BuildConfiguration) --no-restore'

        - task: DotNetCoreCLI@2
          displayName: 'Publish test binaries'
          inputs:
            command: publish
            publishWebProjects: false
            projects: '$(TestProject)'
            arguments: '--configuration $(BuildConfiguration) --no-build --output $(Build.ArtifactStagingDirectory)/drop/tests'

        - publish: '$(Build.ArtifactStagingDirectory)/drop'
          artifact: drop

- stage: CodeQuality
  displayName: '3) Code Quality'
  dependsOn: Build
  jobs:
    - job: SonarAndCoverage
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
        - task: UseDotNet@2
          inputs:
            packageType: sdk
            version: $(DotNetSdkVersion)

        - task: SonarQubePrepare@5
          inputs:
            SonarQube: '$(SonarServiceConnection)'
            scannerMode: 'MSBuild'
            projectKey: 'E2ETestFramework'
            projectName: 'E2ETestFramework'
            extraProperties: |
              sonar.cs.vstest.reportsPaths=$(Agent.TempDirectory)/**/*.trx
              sonar.cs.opencover.reportsPaths=$(Agent.TempDirectory)/qualitytests/**/coverage.opencover.xml

        - task: DotNetCoreCLI@2
          displayName: 'Run tests with coverage'
          inputs:
            command: test
            projects: '$(TestProject)'
            arguments: '--configuration $(BuildConfiguration) --logger trx --results-directory $(Agent.TempDirectory)/qualitytests /p:CollectCoverage=true /p:CoverletOutput=$(Agent.TempDirectory)/qualitytests/coverage/ /p:CoverletOutputFormat=opencover,cobertura'

        - task: PowerShell@2
          displayName: 'Enforce coverage >= $(CoverageThreshold)%'
          inputs:
            targetType: inline
            script: |
              $coverageFile = Get-ChildItem -Path "$(Agent.TempDirectory)/qualitytests" -Filter 'coverage.cobertura.xml' -Recurse | Select-Object -First 1
              if (-not $coverageFile) {
                Write-Error "Coverage file not found (coverage.cobertura.xml)"
                exit 1
              }
              [xml]$coverage = Get-Content $coverageFile.FullName
              $lineRate = [math]::Round(([double]$coverage.coverage.'line-rate') * 100, 2)
              Write-Host "Line coverage: $lineRate%"
              if ($lineRate -lt [double]"$(CoverageThreshold)") {
                Write-Error "Coverage $lineRate% below threshold $(CoverageThreshold)%"
                exit 1
              }

        - task: SonarQubeAnalyze@5
        - task: SonarQubePublish@5
          inputs:
            pollingTimeoutSec: '300'

- stage: Security
  displayName: '4) Security / DevSecOps'
  dependsOn: CodeQuality
  jobs:
    - job: SecurityScans
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
        - task: UseDotNet@2
          inputs:
            packageType: sdk
            version: $(DotNetSdkVersion)

        - script: |
            dotnet restore E2ETestFramework.sln
            dotnet list E2ETestFramework.sln package --vulnerable --include-transitive > $(Build.ArtifactStagingDirectory)/dependency-vulnerabilities.txt
            if grep -q 'has the following vulnerable packages' $(Build.ArtifactStagingDirectory)/dependency-vulnerabilities.txt; then
              echo "Vulnerable packages found" >&2
              exit 1
            fi
          displayName: 'Dependency vulnerability scan (.NET)'

        - script: |
            docker run --rm -v $(Build.SourcesDirectory):/src -v $(Build.ArtifactStagingDirectory):/report \
              owasp/dependency-check:latest --scan /src --format JSON --out /report --project E2ETestFramework
          displayName: 'OWASP Dependency-Check scan'

        - script: |
            docker run --rm -v $(Build.SourcesDirectory):/repo zricethezav/gitleaks:latest detect \
              --source /repo --report-path /repo/gitleaks-report.json
          displayName: 'Secrets detection with Gitleaks'

        - publish: $(Build.ArtifactStagingDirectory)
          artifact: security-reports

- stage: TestExecution
  displayName: '5) Test Execution'
  dependsOn: Security
  jobs:
    - template: templates/e2e-test-template.yml
      parameters:
        suite: smoke
        browser: chrome
    - template: templates/e2e-test-template.yml
      parameters:
        suite: smoke
        browser: firefox
    - template: templates/e2e-test-template.yml
      parameters:
        suite: smoke
        browser: edge
    - template: templates/e2e-test-template.yml
      parameters:
        suite: regression
        browser: chrome
    - template: templates/e2e-test-template.yml
      parameters:
        suite: regression
        browser: firefox
    - template: templates/e2e-test-template.yml
      parameters:
        suite: regression
        browser: edge
    - template: templates/e2e-test-template.yml
      parameters:
        suite: security
        browser: chrome
    - template: templates/e2e-test-template.yml
      parameters:
        suite: security
        browser: firefox
    - template: templates/e2e-test-template.yml
      parameters:
        suite: security
        browser: edge
    - template: templates/e2e-test-template.yml
      parameters:
        suite: accessibility
        browser: chrome
    - template: templates/e2e-test-template.yml
      parameters:
        suite: accessibility
        browser: firefox
    - template: templates/e2e-test-template.yml
      parameters:
        suite: accessibility
        browser: edge

- stage: Containerize
  displayName: '6) Containerização'
  dependsOn: TestExecution
  jobs:
    - job: BuildPushImage
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
        - task: Docker@2
          displayName: 'Build and push test image'
          inputs:
            command: buildAndPush
            repository: $(DockerRepository)
            dockerfile: Dockerfile.tests
            containerRegistry: $(ContainerRegistryServiceConnection)
            tags: |
              $(Build.BuildId)-$(Build.SourceVersion)
              latest

- stage: Deploy_Dev
  displayName: '7) Deploy DEV (auto)'
  dependsOn: Containerize
  condition: succeeded()
  jobs:
    - template: templates/deploy-template.yml
      parameters:
        environmentName: dev
        requireManualApproval: false

- stage: Deploy_QA
  displayName: '8) Deploy QA (auto)'
  dependsOn: Deploy_Dev
  condition: succeeded()
  jobs:
    - template: templates/deploy-template.yml
      parameters:
        environmentName: qa
        requireManualApproval: false

- stage: Deploy_Staging
  displayName: '9) Deploy STAGING (manual approval)'
  dependsOn: Deploy_QA
  condition: succeeded()
  jobs:
    - template: templates/deploy-template.yml
      parameters:
        environmentName: staging
        requireManualApproval: true

- stage: Deploy_Prod
  displayName: '10) Deploy PROD (double approval)'
  dependsOn: Deploy_Staging
  condition: succeeded()
  jobs:
    - template: templates/deploy-template.yml
      parameters:
        environmentName: prod
        requireManualApproval: true

- stage: PostDeployValidation
  displayName: '11) Post-deploy Smoke + Rollback trigger'
  dependsOn: Deploy_Prod
  condition: succeeded()
  jobs:
    - template: templates/e2e-test-template.yml
      parameters:
        suite: smoke
        browser: chrome
        postDeploy: true

- stage: Rollback
  displayName: '12) Auto Rollback'
  dependsOn: PostDeployValidation
  condition: failed('PostDeployValidation')
  jobs:
    - job: RollbackJob
      pool:
        vmImage: ubuntu-latest
      steps:
        - script: |
            echo "Post deploy smoke failed. Rolling back to previous stable release..."
            echo "##vso[task.setvariable variable=RollbackExecuted;isOutput=true]true"
          displayName: 'Execute rollback strategy'

- stage: Notifications
  displayName: '13) Intelligent notifications + metrics export'
  dependsOn:
    - TestExecution
    - Deploy_Prod
    - Rollback
  condition: always()
  jobs:
    - job: Notify
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
        - task: DownloadPipelineArtifact@2
          displayName: 'Download evidence artifacts'
          inputs:
            buildType: current
            targetPath: '$(Pipeline.Workspace)/all-artifacts'
        - task: AzureKeyVault@2
          inputs:
            azureSubscription: 'sc-azure-subscription-enterprise'
            KeyVaultName: '$(KeyVaultName)'
            SecretsFilter: 'teams-webhook,smtp-host,smtp-port,smtp-user,smtp-password,smtp-to'
            RunAsPreJob: false

        - template: templates/notification-template.yml
          parameters:
            teamsWebhook: '$(teams-webhook)'
            smtpHost: '$(smtp-host)'
            smtpPort: '$(smtp-port)'
            smtpUser: '$(smtp-user)'
            smtpPassword: '$(smtp-password)'
            smtpTo: '$(smtp-to)'
